/** 
 * jibo-sync - Sync an entire a directory over HTTP; including incremental changes
 * @version v0.2.4
 * Copyright (c) 2016, Jibo, Inc. All rights reserved.
 * All use of the Jibo SDK is subject to the Jibo SDK End User License Agreement (EULA) 
 * distributed herewith.  If you did not receive a copy of the EULA, you may view a
 * copy at https://developers.jibo.com/license.
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.jiboSync=e()}}(function(){return function e(t,n,o){function i(u,l){if(!n[u]){if(!t[u]){var f="function"==typeof require&&require;if(!l&&f)return f(u,!0);if(r)return r(u,!0);var a=new Error("Cannot find module '"+u+"'");throw a.code="MODULE_NOT_FOUND",a}var s=n[u]={exports:{}};t[u][0].call(s.exports,function(e){var n=t[u][1][e];return i(n?n:e)},s,s.exports,e,t,n,o)}return n[u].exports}for(var r="function"==typeof require&&require,u=0;u<o.length;u++)i(o[u]);return i}({1:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Client"),r=o(i),u=e("./Server"),l=o(u),f=e("./Stopper"),a=o(f);let s=new a["default"];class d{static createServer(e,t,n,o){l.default.start(e,t,n,function(e,t){if(e){console.log(e);o(e)}else{console.log(t);o(null)}})}static uploadToServer(e,t,n,o,i){s.reset();r.default.push(e,t,o,function(t,u){if(n){r.default.done(e,function(e){if(e&&o){console.log(e)}i(t,u)})}else{i(t,u)}})}static closeServer(e,t){r.default.done(e,function(e,n){t(e,n)})}static stop(){s.stop()}}n["default"]=d},{"./Client":2,"./Server":6,"./Stopper":7}],2:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function i(e){return"string"!=typeof e?".":e}function r(e,t){return new Promise(function(n,o){if(C.doStop)return void o(E["default"].STOPPED);P["default"].log("Generating server list... ");let i=Date.now(),r={host:e,port:t,path:"/checksum",method:"POST"},u=d["default"].request(r,function(r){if(C.doStop)return void o(E["default"].STOPPED);r.setEncoding("utf8");let u="";r.on("data",function(e){u+=e}),r.on("end",function(r){if(C.doStop)o(E["default"].STOPPED);else if(r)o("Cannot connect to "+e+":"+t+" or it is already in use.");else{let l=JSON.parse(u);P["default"].log("	took "+(Date.now()-i)/1e3+" secs"),n(l)}})});u.end()})}function u(e,t){return new Promise(function(n,o){return C.doStop?void o(E["default"].STOPPED):void P["default"].generateChecksum(e,!0).then(function(e){if(C.doStop)return void o(E["default"].STOPPED);let i=[],r=[];for(let u in e)t.hasOwnProperty(u)?(t[u]!==e[u]&&r.push(u),delete t[u]):r.push(u);for(let l in t)i.push(l);n({updateList:r,deleteList:i})})["catch"](function(e){o("Error retrieving update list:  "+e)})})}function l(e,t,n,o,i){return new Promise(function(r,u){return C.doStop?void u(E["default"].STOPPED):0===i.length&&0===o.length?(P["default"].log("Everything is already up to date"),void r({size:0,compSize:0})):void f(e,t,i,function(i){return C.doStop?void u(E["default"].STOPPED):(i&&P["default"].log("Delete failed",i),void a(e,t,o,n,function(e,t,n){C.doStop?u(E["default"].STOPPED):e?u(e):r({size:t,compSize:n})}))})})}function f(e,t,n,o){if(n.length>0){P["default"].log("\nDeleting "+n.length+" files");let i=JSON.stringify({deleteList:n}),r={host:e,port:t,path:"/delete",method:"POST",headers:{"Content-Type":"application/json","Content-Length":i.length}},u=d["default"].request(r,function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){o("ERROR"===e.status?t:null)})});u.on("error",function(e){o(e)}),u.write(i),u.end()}else o(null)}function a(e,t,n,o,i){if(n.length>0){P["default"].log("\nUpdating "+n.length+" files from "+o);let r="http://"+e+":"+t+"/upload",u=S["default"].post(r),l=new m["default"],f=new m["default"],a=g["default"].pack(o,{entries:n,dereference:!0}),s=a.pipe(l).pipe(p["default"].createGzip({level:9})).pipe(f).pipe(u);C.once("stop",function(){s.abort(),i(E["default"].STOPPED)}),s.on("end",function(e){i(e,l.bytes,f.bytes)}),s.on("error",function(e){i(e,null,null)})}else i(null,0,0)}Object.defineProperty(n,"__esModule",{value:!0});var s=e("http"),d=o(s),c=e("zlib"),p=o(c),h=e("tar-fs"),g=o(h),v=e("stream-meter"),m=o(v),O=e("request"),S=o(O),y=e("./Common"),P=o(y),w=e("./FailErrors"),E=o(w),b=e("./Stopper"),T=o(b);let C=new T["default"];class R{static push(e,t,n,o){P.default.setVerbose(n);let f=P.default.getHostPort(e);if(!f){o("Error parsing url into host:port");return}let a=f.host;let s=f.port;let d=i(t);let c=Date.now();r(a,s).then(function(e){return u(d,e)}).then(function(e){let t=e.updateList;let n=e.deleteList;return l(a,s,d,t,n)}).then(function(){o(null,"Done in "+(Date.now()-c)/1e3+" seconds")}).catch(function(e){o(e)})}static done(e,t){let n=P.default.getHostPort(e);if(!n){t("Error parsing url into host:port",null);return}let o={host:n.host,port:n.port,path:"/close",method:"POST"};let i=d.default.request(o,function(e){let n="";e.on("data",function(e){n+=e});e.on("end",function(){let o;try{o=JSON.parse(n)}catch(i){e.writeHead(200,{"Content-Type":"text/html"});e.write(JSON.stringify({Status:"ERROR",Message:"Invalid request to close sync server. Request body is not valid JSON"}));e.end();return}if(o.Status==="ERROR"){t(o.Message,null)}else{t(null,o.Message)}})});i.end()}}n["default"]=R,R.FAIL_ERRORS=E["default"],n["default"]=R},{"./Common":4,"./FailErrors":5,"./Stopper":7,http:void 0,request:void 0,"stream-meter":void 0,"tar-fs":void 0,zlib:void 0}],3:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var i=e("./API"),r=o(i),u=e("path"),l=o(u);class f{constructor(e){this.allowedCommands=[["create-server","[port] [dest] [--verbose]","Create a sync server on current IP with specified port and designated destination directory"],["start","[url] [source] [--verbose]","Sync source directory to specified server url (ip:port)"]];this.allowedOptions=[["-h","--help","Output usage information"],["-V","--version","Output the version number"]];this.rootPath=l.default.dirname(e);this.parse()}parse(){var t=this;let n=false;let o=process.argv[2];if(o===this.allowedOptions[0][0]||o===this.allowedOptions[0][1]){n=true;this.printUsage()}let i=e(l.default.join(this.rootPath,"package.json"));if(o===this.allowedOptions[1][0]||o===this.allowedOptions[1][1]){n=true;console.log(`\n${i.version}\n`)}if(!n){let r=this.allowedCommands.length;for(let u=0;u<r;u++){let f=this.allowedCommands[u][0];if(o===f){n=true;let a=process.argv.slice(3,process.argv.length);this.processCommand(f,a,function(e,n){if(e){console.log(`\n${e}`);t.printUsage()}else{console.log(`\n${n}\n`)}})}}}if(!n){this.printUsage()}return n}printUsage(){let e=40;console.log("\n  Usage: sync [options] [command]\n\n");console.log("  Commands:\n");this.allowedCommands.forEach(function(t){let n=e-t[0].length-t[1].length;if(n<=0){n=4}let o="";for(var i=0;i<n;i++){o+=" "}console.log(`    ${t[0]} ${t[1]}${o}${t[2]}`)});console.log("\n  Options:\n");this.allowedOptions.forEach(function(t){let n=", ";let o=e-t[0].length-t[1].length-n.length;if(o<=0){o=4}let i="";for(let r=0;r<o;r++){i+=" "}console.log(`    ${t[0]}${n}${t[1]} ${i}${t[2]}`)});console.log("")}processCommand(e,t,n){if(e==="create-server"){let o=true;if(t[2]==="--verbose"){o=t[3]}r.default.createServer(t[0],t[1],o,function(e,t){n(e,t)})}else if(e==="start"){let o=true;if(t[2]==="--verbose"){o=t[3]}r.default.uploadToServer(t[0],t[1],false,o,function(e,t){n(e,t)})}else{n(`Undefined command: ${e}`,null)}}}n["default"]=f},{"./API":1,path:void 0}],4:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function i(e){R.log(e)}function r(e,t,n,o){return C.doStop?void o(b["default"].STOPPED):void c["default"].readdir(t,function(u,l){if(u)return void o(u,null);let a,s=[];l=l.filter(function(o){for(let i=h["default"].join(t,o),r=h["default"].relative(e,i),u=n.length,l=!0,f=0;u>f;++f)if((0,O["default"])(r,n[f])){l=!1;break}return l}),a=l.filter(function(e){if(!t)return!1;let n=h["default"].join(t,e);try{let o=c["default"].statSync(n);return o&&o.isDirectory()}catch(r){return i("Error getting file info on "+n+"; skipping.."),!1}}),l=l.filter(function(e){if(!t)return!1;let n=h["default"].join(t,e);try{let o=c["default"].statSync(n);return o&&o.isFile()}catch(r){return i("Error getting file info on "+n+"; skipping.."),!1}}),l=l.map(function(e){return h["default"].join(t,e)}),s=s.concat(l);let d=[];a.forEach(function(o){d.push(function(i){let u=h["default"].join(t,o);r(e,u,n,function(e,t){s=s.concat(t),i()})})}),f["default"].parallelLimit(d,5,function(e){C.doStop?o(b["default"].STOPPED):e?(console.error("Error executing recursive file find: "+e),o(e,null)):o(null,s)})})}function u(e,t){return e?void(T?c["default"].stat(h["default"].normalize(e),function(n,o){if(o){let r=o.mtime;return y["default"].isDate(r)&&(r=Math.trunc(r.getTime()/1e3)),void t(r)}i("Error getting checksum for "+e+": "+n),t(null)}):c["default"].readFile(h["default"].normalize(e),function(n,o){if(o){let r=s["default"].createHash("md5");return r.update(o),void t(r.digest("hex"))}i("Error getting checksum for "+e+": "+n),t(null)})):void t(null)}Object.defineProperty(n,"__esModule",{value:!0});var l=e("async"),f=o(l),a=e("crypto"),s=o(a),d=e("fs"),c=o(d),p=e("path"),h=o(p),g=e("parse-gitignore"),v=o(g),m=e("minimatch"),O=o(m),S=e("util"),y=o(S),P=e("./Stopper"),w=o(P),E=e("./FailErrors"),b=o(E);let T=!0,C=new w["default"];Math.trunc=Math.trunc||function(e){return 0>e?Math.ceil(e):Math.floor(e)};class R{static generateChecksum(e,t){return new Promise(function(n,o){if(!e){o(b.default.NO_DIRECTORY);return}let l=t?(0,v.default)(h.default.resolve(e,"./.syncignore")):[];let a=e.replace(/\/$/,"");c.default.stat(a,function(e,t){if(e||t&&!t.isDirectory()){let s="Directory "+a+" does not exist.";o(s);return}let d=Date.now();i("Retrieving file list from "+a+"...");r(a,a,l,function(e,t){if(e){o(e);return}i("	took "+(Date.now()-d)/1e3+" secs");let r=t;r=r.map(function(e){return h.default.relative(a,e)});let l=[];let s={};r.forEach(function(e){l.push(function(t){if(C.doStop){t(b.default.STOPPED);return}e=h.default.normalize(e);let n=h.default.join(a,e);u(n,function(n){if(n){e=e.replace(/\\/g,"/");s[e]=n}t()})})});i("Generating checksum list...");d=Date.now();f.default.parallelLimit(l,5,function(e){if(e){i("Error executing checksums: "+e);o(e)}else{i("	took "+(Date.now()-d)/1e3+" secs");n(s)}})})})})}static getHostPort(e){let t=e.split(":");if(t.length!==2){i("Url is not specified as [IP:port]: "+e);return undefined}let n=t[0];let o=Number(t[1]);if(isNaN(o)){i("Invalid port defined "+o);return undefined}return{host:n,port:o}}static setVerbose(e){R.verboseLog=e}static log(e){if(R.verboseLog){console.log(e)}}static error(e){if(R.verboseLog){console.error(e)}}}R.verboseLog=!1,n["default"]=R},{"./FailErrors":5,"./Stopper":7,async:void 0,crypto:void 0,fs:void 0,minimatch:void 0,"parse-gitignore":void 0,path:void 0,util:void 0}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n["default"]={NO_PORT_SPECIFIED:"NO_PORT_SPECIFIED",CANNOT_CONNECT:"CANNOT_CONNECT",NO_DIRECTORY:"No directory was specified. Aborting checksum.",ERROR:"ERROR",STOPPED:"STOPPED"}},{}],6:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if("POST"===e.method)switch(e.url){case M:l(e,t);break;case x:a(e,t);break;case k:u(e,t);break;case j:s(e,t);break;case I:d(e,t);break;default:t.writeHead(200,{"Content-Type":"text/html"}),t.write(JSON.stringify({Status:"ERROR",Message:"Undefined url: "+e.url})),t.end()}}function r(e){_?(_.close(),_=void 0,e(null,"Server closed on port "+D)):e("No server to close",null)}function u(e,t){"POST"===e.method&&R["default"].generateChecksum(N,!1).then(function(e){t.writeHead(200,{"Content-Type":"text/html"}),t.write(JSON.stringify(e)),t.end()})["catch"](function(e){t.writeHead(200,{"Content-Type":"text/html"}),t.write(JSON.stringify({Status:"ERROR",Message:e})),t.end()})}function l(e,t){R["default"].log("Receiving upload...");let n=Date.now();"POST"===e.method&&f(e,N,function(e,o,i){R["default"].log("	took "+(Date.now()-n)/1e3+" secs"),R["default"].log("	"+o+" bytes uploaded ("+i+" compressed)"),t.writeHead(200,"OK",{"Content-Type":"text/html"}),t.end()})}function f(e,t,n){g["default"].ensureDirSync(t);let o=new S["default"],i=new S["default"],r={dmode:365,fmode:365};e.pipe(i).pipe(T["default"].createGunzip()).pipe(o).pipe(E["default"].extract(t,r)).on("finish",function(e){e?(R["default"].log("Problem extracting tar stream",e),n(e)):n(null,o.bytes,i.bytes)}),e.on("error",function(e){e&&R["default"].log("problem with POST stream",e),n(e)})}function a(e,t){R["default"].log("Receiving delete request...");let n=Date.now();if("POST"===e.method){let o="";e.on("data",function(e){o+=e}),e.on("end",function(){let e=void 0;try{e=JSON.parse(o)}catch(i){return t.writeHead(200,{"Content-Type":"text/html"}),t.write(JSON.stringify({Status:"ERROR",Message:"Invalid delete request. Request body is not valid JSON"})),void t.end()}let r=e.deleteList;if(void 0!==r){let u=[];r.forEach(function(e){u.push(function(t){let n=P["default"].resolve(N,e);g["default"].remove(n,t)})}),p["default"].parallelLimit(u,5,function(e){e?(R["default"].log("Error executing deletes: "+e),t.writeHead(200,"OK",{"Content-Type":"text/html"}),t.write(JSON.stringify({Status:"ERROR",Message:e})),t.end()):(t.writeHead(200,"OK",{"Content-Type":"text/html"}),t.end()),R["default"].log("	took "+(Date.now()-n)/1e3+" secs")})}})}}function s(e,t){r(function(e,n){e?(R["default"].log(e),t.writeHead(200,{"Content-Type":"text/html"}),t.write(JSON.stringify({Status:"ERROR",Message:e})),t.end()):(R["default"].log(n),t.writeHead(200,"OK",{"Content-Type":"text/html"}),t.write(JSON.stringify({Status:"OK",Message:n})),t.end())})}function d(e,t){"POST"===e.method&&(t.writeHead(200,"OK",{"Content-Type":"text/html"}),t.end())}Object.defineProperty(n,"__esModule",{value:!0});var c=e("async"),p=o(c),h=e("fs-extra"),g=o(h),v=e("http"),m=o(v),O=e("stream-meter"),S=o(O),y=e("path"),P=o(y),w=e("tar-fs"),E=o(w),b=e("zlib"),T=o(b),C=e("./Common"),R=o(C);let _=void 0,D=void 0,N=".";const M="/upload",x="/delete",k="/checksum",j="/close",I="/ping";class L{static start(e,t,n,o){R.default.setVerbose(n);D=Number(e);if(isNaN(D)){o("\nInvalid port defined: "+D+" Aborting.",null);return}if(_){if(t){N=t}o(null,"\nSync server already listening on port "+D)}else{if(t){N=t}_=m.default.createServer(i);try{_.listen(D,"0.0.0.0",function(e){if(e){_.close();_=undefined;o(e,null)}else{o(null,"\nSync server listening on port "+D+". Press CTRL+C or call stop() to exit.\n")}});_.timeout=0}catch(r){_.close();_=undefined;o(r,null)}}}}n["default"]=L},{"./Common":4,async:void 0,"fs-extra":void 0,http:void 0,path:void 0,"stream-meter":void 0,"tar-fs":void 0,zlib:void 0}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("events");class i extends o.EventEmitter{constructor(){super();this._doStop=false}stop(){this._doStop=true;this.emit("stop")}get doStop(){return this._doStop}reset(){this.removeAllListeners();this._doStop=false}}n["default"]=i},{events:void 0}],8:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var i=e("./API"),r=o(i),u=e("./Command"),l=o(u);r["default"].Command=l["default"],n["default"]=r["default"]},{"./API":1,"./Command":3}]},{},[8])(8)});